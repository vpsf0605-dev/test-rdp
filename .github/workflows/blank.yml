name: üöÄ ZUNRDP - L∆ØU T√ÄI KHO·∫¢N GOOGLE

on:
  workflow_dispatch:
    inputs:
      token_choice:
        description: 'üîë Ch·ªçn Token'
        default: 'Token_1'
        type: choice
        options: ['Token_1', 'Token_2']

jobs:
  Zun-Premium:
    runs-on: windows-2025
    timeout-minutes: 360
    
    steps:
      - name: üîß 1. C√ÄI ƒê·∫∂T & T·∫¢I D·ªÆ LI·ªÜU C≈® (BAO G·ªíM CHROME PROFILE)
        env:
          MEGA_MAIL: ${{ secrets.MEGA_EMAIL }}
          MEGA_PASS: ${{ secrets.MEGA_PASSWORD }}
        run: |
          # 1. T·∫°o User & M·ªü RDP
          $Password = ConvertTo-SecureString "ZunRDP@123456" -AsPlainText -Force
          New-LocalUser -Name "ADMINZUN" -Password $Password -AccountNeverExpires -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member "ADMINZUN"
          
          # 2. C√†i Chrome v√† Mega
          choco install googlechrome megacmd -y --no-progress
          $env:PATH += ";C:\Program Files\MEGAcmd"
          
          # 3. ƒêƒÉng nh·∫≠p Mega & T·∫£i b·∫£n l∆∞u
          mega-login $env:MEGA_MAIL $env:MEGA_PASS
          mega-get /ZunData.zip C:\ -ErrorAction SilentlyContinue
          
          # 4. N·∫øu c√≥ b·∫£n l∆∞u, ti·∫øn h√†nh gi·∫£i n√©n v√†o h·ªá th·ªëng
          if (Test-Path "C:\ZunData.zip") {
              Write-Host "üì¶ ƒêang ph·ª•c h·ªìi t√†i kho·∫£n Google v√† File..." -ForegroundColor Cyan
              Expand-Archive -Path "C:\ZunData.zip" -DestinationPath "C:\Users\ADMINZUN\" -Force
              Remove-Item "C:\ZunData.zip"
          }

      - name: üåê 2. K·∫æT N·ªêI TAILSCALE
        env:
          TOKEN_1: ${{ secrets.TAILSCALE_AUTH_KEY }}
          TOKEN_2: ${{ secrets.TAILSCALE_AUTH_KEY_2 }}
        run: |
          $Token = if ("${{ github.event.inputs.token_choice }}" -eq "Token_1") { $env:TOKEN_1 } else { $env:TOKEN_2 }
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "ts.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "ts.msi", "/quiet" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$Token --hostname=zun-vps-2025 --accept-routes --reset

      - name: ‚è≥ 3. TREO M√ÅY & KI·ªÇM TRA L·ªÜNH L∆ØU
        run: |
          Write-Host "üëâ MU·ªêN L∆ØU T·∫§T C·∫¢ T√ÄI KHO·∫¢N GOOGLE: T·∫°o Folder 'SAVE_NOW' tr√™n Desktop" -ForegroundColor Yellow
          $timeout = New-TimeSpan -Minutes 350
          $sw = [diagnostics.stopwatch]::StartNew()
          while ($sw.Elapsed -lt $timeout) {
              if (Test-Path "C:\Users\ADMINZUN\Desktop\SAVE_NOW") {
                  Write-Host "üîî ƒêang sao l∆∞u t√†i kho·∫£n v√† d·ªØ li·ªáu..." -ForegroundColor Magenta
                  Stop-Process -Name "chrome" -ErrorAction SilentlyContinue # Ph·∫£i ƒë√≥ng Chrome m·ªõi l∆∞u ƒë∆∞·ª£c d·ªØ li·ªáu
                  Start-Sleep -Seconds 3
                  
                  # N√©n to√†n b·ªô Profile Chrome + Desktop
                  Compress-Archive -Path "C:\Users\ADMINZUN\Desktop", "C:\Users\ADMINZUN\AppData\Local\Google\Chrome\User Data" -DestinationPath "C:\ZunData.zip" -Force
                  
                  $env:PATH += ";C:\Program Files\MEGAcmd"
                  mega-put -c C:\ZunData.zip /
                  Remove-Item "C:\Users\ADMINZUN\Desktop\SAVE_NOW" -Recurse -Force
                  Write-Host "‚úÖ ƒê√É L∆ØU XONG T√ÄI KHO·∫¢N L√äN MEGA!" -ForegroundColor Green
              }
              Start-Sleep -Seconds 10
          }

      - name: üì¶ 4. T·ª∞ ƒê·ªòNG L∆ØU CU·ªêI GI·ªú
        if: always()
        run: |
          Stop-Process -Name "chrome" -ErrorAction SilentlyContinue
          $env:PATH += ";C:\Program Files\MEGAcmd"
          Compress-Archive -Path "C:\Users\ADMINZUN\Desktop", "C:\Users\ADMINZUN\AppData\Local\Google\Chrome\User Data" -DestinationPath "C:\ZunData.zip" -Force
          mega-put -c C:\ZunData.zip /
          mega-logout
          
